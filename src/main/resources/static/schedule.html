<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ’èª²å·¥ä½œå°</title>
    <style>
        /* æ¨£å¼ä¿æŒåŸæ¨£ï¼Œå› ç‚ºä¹‹å‰è¨­è¨ˆå¾—ä¸éŒ¯ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; background-color: #f8f9fa; }
        
        .left-panel { flex: 3; padding: 20px; display: flex; flex-direction: column; }
        .grid-container { 
            display: grid; grid-template-columns: 60px repeat(5, 1fr); gap: 1px; 
            flex-grow: 1; margin-top: 10px; background: #ced4da; 
            border: 2px solid #ced4da; border-radius: 4px;
            user-select: none; /* å¿…å‚™ï¼šé˜²æ­¢é¸å–æ–‡å­— */
        }
        .grid-header { background: #343a40; color: white; text-align: center; padding: 10px; font-weight: bold; }
        .period-label { background: #e9ecef; color: #495057; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .grid-cell { 
            background: white; display: flex; align-items: center; justify-content: center; 
            position: relative; min-height: 50px; font-size: 16px; font-weight: bold; color: #333;
            cursor: pointer;
        }
        .grid-cell:hover { filter: brightness(0.95); }
        .grid-cell.busy { 
            background-color: #e2e3e5 !important; color: #adb5bd;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px);
            cursor: not-allowed; pointer-events: none;
        }

        .right-panel { flex: 1; padding: 20px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: -4px 0 15px rgba(0,0,0,0.05); }
        .course-pool { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        
        .pool-item { 
            padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; transition: all 0.1s; border: 3px solid transparent;
            color: #555; background-color: #f1f3f5;
        }
        .pool-item:hover { background-color: #e9ecef; }
        .pool-item.active { border-color: #333; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transform: scale(1.02); }
        .pool-item.empty { opacity: 0.5; filter: grayscale(100%); }
        
        .badge { background: #6c757d; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; }
        .badge.done { background: #28a745; }

        .btn-save { background: #28a745; color: white; border: none; padding: 15px; width: 100%; font-size: 18px; cursor: pointer; margin-top: 10px; border-radius: 8px; transition: background 0.2s; }
        .btn-back { background: #6c757d; color: white; border: none; padding: 10px; width: 100%; margin-top: 5px; cursor: pointer; border-radius: 8px; }
        
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .eraser { cursor: pointer; padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; background: #fff; user-select: none; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .eraser.active { background: #ffc107; border-color: #e0a800; font-weight: bold; color: #856404; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div class="left-panel">
        <div class="toolbar">
            <h2 style="margin:0;">ğŸ“… æ’èª²å·¥ä½œå° <span id="teacherName" style="font-size:0.6em; color:#666; font-weight:normal;"></span></h2>
            <div id="eraserBtn" class="eraser" onclick="selectEraser()">
                <span style="font-size: 1.2em;">ğŸ§¹</span> æ©¡çš®æ“¦
            </div>
        </div>
        <div class="grid-container" id="scheduleGrid"></div>
    </div>

    <div class="right-panel">
        <h3 style="margin-top:0;">ğŸ¨ èª²ç¨‹ç•«ç­†</h3>
        <p style="font-size:13px; color:#666;">é»é¸å³å´èª²ç¨‹ï¼Œç„¶å¾Œåœ¨å·¦å´æ ¼å­æ»‘å‹•</p>
        <div class="course-pool" id="coursePool"></div>
        <button class="btn-save" onclick="saveSchedule()">ğŸ’¾ å„²å­˜èª²è¡¨</button>
        <button class="btn-back" onclick="location.href='index.html'">å›ä¸Šä¸€é </button>
    </div>

    <script>
        const tid = localStorage.getItem('teacherId');
        const tName = localStorage.getItem('teacherName');
        document.getElementById('teacherName').innerText = tName;

        const DAYS = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”'];
        let busySlots = [];
        let courseNeeds = {}; 
        
        const PALETTE = {
            'åœ‹æ–‡': '#FFB7B2', 'è‹±æ–‡': '#AEC6CF', 'æ•¸å­¸': '#B9D7EA',
            'è‡ªç„¶': '#C8E6C9', 'ç¤¾æœƒ': '#E6EE9C', 'default': '#E0E0E0'
        };

        // --- æ ¸å¿ƒè®Šæ•¸ï¼šè·Ÿ index.html ä¸€æ¨¡ä¸€æ¨£çš„é‚è¼¯ ---
        let isMouseDown = false; 
        let selectedSubject = null;
        let isEraser = false;

        // åˆå§‹åŒ–
        (async function init() {
            try {
                await loadAvailability();
                await loadRequirements();
                renderGrid();
                await loadExistingSchedule(); 
                renderSidebar();
                autoSelectFirstSubject();     
            } catch (e) {
                console.error(e);
            }
        })();

        async function loadAvailability() {
            const res = await fetch(`/api/teachers/${tid}/availability`);
            busySlots = await res.json();
        }

        async function loadRequirements() {
            const res = await fetch(`/api/teachers/${tid}/courses`);
            const data = await res.json();
            data.forEach(c => courseNeeds[c.subject] = c.sessions);
        }

        // --- 1. æ¸²æŸ“ç¶²æ ¼ ---
        function renderGrid() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '<div class="grid-header">ç¯€</div>';
            DAYS.forEach(d => grid.innerHTML += `<div class="grid-header">${d}</div>`);

            for (let p = 1; p <= 8; p++) {
                grid.innerHTML += `<div class="period-label">${p}</div>`;
                for (let d = 1; d <= 5; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.day = d;
                    cell.dataset.period = p;

                    // æª¢æŸ¥æ˜¯å¦å¿™ç¢Œ
                    const isBusy = busySlots.some(b => b.dayOfWeek === d && b.period === p);
                    if (isBusy) {
                        cell.classList.add('busy');
                        cell.innerText = "âœ–";
                    } else {
                        // --- é€™è£¡çš„é‚è¼¯æ”¹å¾—è·Ÿ index.html çš„ toggleCell å®Œå…¨ä¸€æ¨£ ---
                        
                        // 1. æ»‘é¼ æŒ‰ä¸‹ï¼šé–‹å§‹ç•«ï¼Œä¸¦æ¨™è¨˜ isMouseDown = true
                        cell.addEventListener('mousedown', () => {
                            isMouseDown = true;
                            paintCell(cell);
                        });

                        // 2. æ»‘é¼ ç¶“éï¼šå¦‚æœ isMouseDown ç‚º trueï¼Œå°±ç¹¼çºŒç•«
                        cell.addEventListener('mouseover', () => { // é€™è£¡æ”¹å› mouseoverï¼Œé€™åœ¨ index.html é‹ä½œæ­£å¸¸
                            if (isMouseDown) {
                                paintCell(cell);
                            }
                        });

                        // 3. é»æ“Šï¼šç‚ºäº†ä¿éšªèµ·è¦‹ï¼Œé»ä¸€ä¸‹ä¹Ÿè¦èƒ½ç•«
                        cell.addEventListener('click', () => {
                            paintCell(cell);
                        });
                    }
                    grid.appendChild(cell);
                }
            }
            
            // å…¨å±€æ”¾é–‹æ»‘é¼ ï¼šåœæ­¢ç¹ªç•«
            document.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
        }

        // --- 2. å¡—è‰²é‚è¼¯ ---
        function paintCell(cell) {
            // é˜²å‘†ï¼šå¦‚æœå·²ç¶“æ˜¯å¿™ç¢Œç‹€æ…‹ï¼Œä¸å‹•ä½œ
            if (cell.classList.contains('busy')) return;

            const oldSubject = cell.dataset.subject;

            // A. æ©¡çš®æ“¦æ¨¡å¼
            if (isEraser) {
                if (oldSubject) {
                    clearCell(cell); // æ“¦æ‰
                    renderSidebar(); // æ›´æ–°æ•¸å­—
                }
                return;
            }

            // B. ç•«ç­†æ¨¡å¼
            if (!selectedSubject) return; // æ²’é¸ç­†åˆ·

            // å¦‚æœè©²æ ¼å·²ç¶“æ˜¯é€™å€‹ç§‘ç›®ï¼Œä¸ç”¨é‡ç•«
            if (oldSubject === selectedSubject) return;

            // æª¢æŸ¥é¤˜é¡ (å¦‚æœæ²’æ‰£æ‰“äº†ï¼Œå°±ä¸å‡†ç•«)
            const remaining = getRemainingCount(selectedSubject);
            if (remaining <= 0) return; 

            // åŸ·è¡Œå¡—è‰²
            fillCell(cell, selectedSubject);
            renderSidebar(); // æ›´æ–°æ•¸å­—
        }

        function fillCell(cell, subject) {
            cell.dataset.subject = subject;
            cell.innerText = subject;
            cell.style.backgroundColor = getColor(subject);
        }

        function clearCell(cell) {
            delete cell.dataset.subject;
            cell.innerText = "";
            cell.style.backgroundColor = "white";
        }

        // --- è¼”åŠ©å‡½å¼ ---
        function getColor(subject) {
            if (PALETTE[subject]) return PALETTE[subject];
            let hash = 0;
            for (let i = 0; i < subject.length; i++) hash = subject.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function getRemainingCount(subject) {
            const total = courseNeeds[subject] || 0;
            const placed = document.querySelectorAll(`.grid-cell[data-subject="${subject}"]`).length;
            return total - placed;
        }

        function renderSidebar() {
            const pool = document.getElementById('coursePool');
            const currentActive = selectedSubject; 
            pool.innerHTML = '';
            
            for (const [subject, total] of Object.entries(courseNeeds)) {
                const remaining = getRemainingCount(subject);
                const div = document.createElement('div');
                div.className = `pool-item ${remaining <= 0 ? 'empty' : ''}`;
                
                if (subject === currentActive && !isEraser) {
                    div.classList.add('active');
                }
                
                const colorBox = `<span style="display:inline-block; width:15px; height:15px; background:${getColor(subject)}; border-radius:50%; margin-right:10px; border:1px solid rgba(0,0,0,0.1);"></span>`;
                
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        ${colorBox} <span>${subject}</span>
                    </div>
                    <span class="badge ${remaining === 0 ? 'done' : ''}">${remaining > 0 ? 'å‰© '+remaining : 'OK'}</span>
                `;
                
                div.onclick = () => selectSubject(subject);
                pool.appendChild(div);
            }
        }

        function selectSubject(subject) {
            selectedSubject = subject;
            isEraser = false;
            document.getElementById('eraserBtn').classList.remove('active');
            renderSidebar(); 
        }

        function selectEraser() {
            isEraser = true;
            document.getElementById('eraserBtn').classList.add('active');
            renderSidebar(); // ç§»é™¤ sidebar çš„ active
        }

        function autoSelectFirstSubject() {
            for (const [subject, total] of Object.entries(courseNeeds)) {
                if (getRemainingCount(subject) > 0) {
                    selectSubject(subject);
                    break;
                }
            }
        }

        async function loadExistingSchedule() {
            const res = await fetch(`/api/teachers/${tid}/schedule`);
            const data = await res.json();
            data.forEach(item => {
                const cell = document.querySelector(`.grid-cell[data-day="${item.dayOfWeek}"][data-period="${item.period}"]`);
                if (cell && !cell.classList.contains('busy')) {
                    fillCell(cell, item.subject);
                }
            });
        }

        async function saveSchedule() {
            const items = [];
            document.querySelectorAll('.grid-cell').forEach(cell => {
                if (cell.dataset.subject) {
                    items.push({
                        dayOfWeek: parseInt(cell.dataset.day),
                        period: parseInt(cell.dataset.period),
                        subject: cell.dataset.subject
                    });
                }
            });

            const res = await fetch(`/api/teachers/${tid}/schedule`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(items)
            });

            if(res.ok) alert("èª²è¡¨å„²å­˜æˆåŠŸï¼ğŸ‰");
            else alert("å„²å­˜å¤±æ•—");
        }
    </script>
</body>
</html>